create view BDR
var
 cC,
 cPlan,
 cPlanDop,
 cFact,
 cPeriod,
 cTForm,
 cCopyBud,
 cStBud,
 cFP :comp;
 sPath :string;
 pathUserOut : string;
 NameExcel   : string;
 wPeriod,mp,i  : word;
 Check: integer;
 isError: boolean;
 sPersons: string;

 extClName     : String;
 extClNamePZap : String;
 excCode1      : String; // разделитель
 excCode2      : String; // итого
 excCode3      : String; // Агрегат
 excCode4      : String;
 excCode5      : String;
 excCode6      : String;

 podpisanty  : SZMN_COMMON::IPodpis (vPodpis) new;// (  ) new;

As select
  if(cPeriod=0   ,'выберите значение',fpPeriod.Name)   (FieldName = sPeriod)
, if(cTForm=0    ,'выберите значение',fpTForm.Name)    (FieldName = sTForm)
, if(cPlan=0     ,'выберите значение',fpBudVar.SBUDSTAGE  + ' | ' + fpBudVar.Name)   (FieldName = sPlan)
, if(cPlanDop=0     ,'выберите значение',fpBudVarDop.SBUDSTAGE  + ' | ' + fpBudVarDop.Name)   (FieldName = sPlanDop)
, if(cFact=0     ,'выберите значение',fpBudVar1.SBUDSTAGE + ' | ' + fpBudVar1.Name)  (FieldName = sFact)
, podpisanty.DialogFieldString  (FieldName = sPodpGrp)
, fpvalues.summa
From
  fpBudVar
 ,synonym  fpPeriod  fpP
 ,synonym  fpPeriod  fpP2
 , fpBudVar  fpBudVarDop
 ,synonym  fpBudVar  fpBudVar1

 ,fpAxTF Axis1
 ,fpAxTF Axis2
 ,fpSpAxTF SpAxis1
 ,fpSpAxTF SpAxis2
 ,fpvalues
 ,Synonym fpBudVar fpBV
 ,Synonym fpValues fpV
 , podpisanty

 // для 2010 года
 , HashAn
 ,Synonym fpValues fpV2
 , fpSpAxtf superKauSpAxtf
 , f91_printed
 , f91_printed subp3
 , fpzap_printed
 , fpzap_printed sub_pzp

 where
((
  // иерархия оси1

cPeriod   == fpPeriod.nrec  and
cTForm         == fpTForm.nrec    and




cPlan     == fpBudVar.nrec   and
cPlanDop  == fpBudVarDop.nrec   and
cFact     == fpBudVar1.nrec


and fpBudVar.cBudget   == FpBudget.nrec

// лог таблица для знач1ений

and fpTForm.nrec   == fpAxTF.cMain     //может быть несколько
and fpAxTF.NRec    == fpSpAxtf.cMain

//and (fpSpAxtf.nRec=comp('013100000001EBCBh')  or fpSpAxtf.cKauNode = comp('013100000001EBCBh')  )
//and (fpSpAxtf.nRec=comp('01310000000202A1h') /* or fpSpAxtf.cKauNode = comp('013100000001EBCBh') */ )

//and (fpSpAxtf.nRec=comp('013100000001EBCBh')  or fpSpAxtf.cNode = comp('013100000001EBCBh')  )

and fpSpAxtf.cMean == fpStBud.nrec


and cCopyBud       == fpBV.nrec
and fpBV.nrec      == fpV.cBudVar
and fpStBud.nrec   == fpV.cStBud
//and cPeriod        == fpV.cPeriod // ссылка на период
and date(01,01,1900)        <<= fpV.cPeriod  // ссылка на период
and word(cFP)      == fpV.KodReg //план факт1
and comp(0)        == fpV.cHashAn (noindex)

and fpV.cPeriod    == fpP.nrec

and fpStBud.ced    == kated.nrec//единицы измерения

// для 2010 года
and fpSpAxtf.cKauNode == superKauSpAxtf.nRec

and fpSpAxtf.CMEAN == HashAn.cAnalit[1] (noindex)
and comp(0)        == HashAn.cBlock (noindex)    //не уверен что всегда 0 из за этого может быть косяк
and HashAn.nRec      == fpV2.cHashAn (noindex)
and fpBV.nrec        == fpV2.cBudVar // вариант бюджета
and word(cFP)        == fpV2.KodReg //план факт резерв
and comp(cStBud)     == fpV2.cStBud // статья бюджета
//and cPeriod          == fpV2.cPeriod // ссылка на период
and date(01,01,1900)  <<= fpV2.cPeriod // ссылка на период
and fpV2.cPeriod     == fpP2.nrec

and f91_printed.cRec == subp3.cNode
//fpzap_printed sub_pzp
and fpzap_printed.cRec == sub_pzp.cNode

))

;

